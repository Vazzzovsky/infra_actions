# .github/workflows/**main.yml**
name: Django-app workflow

on: [push]

jobs:
  tests:
    # «Раннер» — создание изолированного окружения с последней версией Ubuntu
    runs-on: ubuntu-latest

    steps:
    # Запуск actions checkout — готового скрипта
    # для клонирования репозитория
    - uses: actions/checkout@v2
    - name: Set up Python
      # Запуск actions setup-python — готового скрипта 
      # для развёртывания окружения Python
      uses: actions/setup-python@v2
      with:
        # Выбор версии Python
        python-version: 3.7

    - name: Install dependencies
      run: | 
        # обновление pip
        python -m pip install --upgrade pip 
        # установка flake8 и его плагинов
        pip install flake8 pep8-naming flake8-broken-line flake8-return flake8-isort
        # установка зависимостей
        pip install -r requirements.txt 

    - name: Test with flake8 and django tests
      run: |
        # запуск проверки проекта по flake8
        python -m flake8
        # перейти в папку, содержащую manage.py — 
        #<корневая_папка_infra_actions>/<папка_проекта>/manage.py
        cd infra_project/
        # запустить написанные разработчиком тесты
        python manage.py test

  build_and_push_to_docker_hub:
    name: Push Docker image to Docker Hub
    runs-on: ubuntu-latest
    needs: tests
    steps:
      - name: Check out the repo
        # Проверка доступности репозитория Docker Hub для workflow
        uses: actions/checkout@v2 
      - name: Set up Docker Buildx
        # Вызов сборщика контейнеров docker
        uses: docker/setup-buildx-action@v1 
      - name: Login to Docker 
        # Запуск скрипта авторизации на Docker Hub
        uses: docker/login-action@v1 
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Push to Docker Hub
        # Пуш образа в Docker Hub
        uses: docker/build-push-action@v2 
        with:
          push: true
          tags: mlisnevsky/practicum_infra_actions:latest 
    
  deploy:
    runs-on: ubuntu-latest
    needs: build_and_push_to_docker_hub
    steps:
    - name: executing remote ssh commands to deploy
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USER }}
        # key: ${{ secrets.SSH_KEY }}
        key: -----BEGIN OPENSSH PRIVATE KEY-----
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
-----END OPENSSH PRIVATE KEY-----

        passphrase: ${{ secrets.PASSPHRASE }}
        script: |
          # Выполняет pull образа с DockerHub
          sudo docker pull mlisnevsky/practicum_infra_actions
          #остановка всех контейнеров
          sudo docker stop $(sudo docker ps -a -q)
          sudo docker run --rm -d -p 3000:3000 mlisnevsky/practicum_infra_actions